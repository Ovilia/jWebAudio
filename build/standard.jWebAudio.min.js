/*
 * Copyright (C) 2013, Intel Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var jWebAudio=function(){window.hasOwnProperty("AudioContext")?this.context=new AudioContext:window.hasOwnProperty("webkitAudioContext")?this.context=new webkitAudioContext:(this.context=null,console.error("Web audio is not supported in current web browser. Please try with the latest Chrome."))};jWebAudio=new jWebAudio,jWebAudio.SoundEngine=function(){this.soundArray=[]},jWebAudio.SoundEngine.prototype={addSoundSource:function(e){if("object"!=typeof e||!e.hasOwnProperty("url"))return void console.error("Error url in addSoundSource.");if(e.preLoad!==!0&&(e.preLoad=!1),"function"!=typeof e.callback&&"object"!=typeof e.callback&&(e.callback=null),e.multishot!==!0&&(e.multishot=!1),"string"==typeof e.url)return this.soundArray.push(new jWebAudio.SoundSource(this.soundArray.length,e)),this.soundArray[this.soundArray.length-1];if("object"==typeof e.url){if(e.preLoad){var t=e.url.length,o=0,n=e.callback;e.callback=function(){++o,o===t&&n&&n()}}var i=this.soundArray.length,r=e.url.slice();for(var u in e.url)e.url=r[u],this.soundArray.push(new jWebAudio.SoundSource(this.soundArray.length,e));for(var a=[],u=i;u<this.soundArray.length;++u)a[u-i]=this.soundArray[u];return a}},destroySound:function(e){this.soundArray[e]&&(this.soundArray[e].isLoaded&&this.soundArray[e].stop(),delete this.soundArray[e])}},jWebAudio.SoundSource=function(e,t){this.id=t.id,this.url=t.url,this.multishot=t.multishot,this.isLoaded=!1,this.options=t,this.finish=t.finish;this.sound=null,t.preLoad===!0&&this.load(t.callback)},jWebAudio.SoundSource.prototype.load=function(e){if(!this.isLoaded){var t=new XMLHttpRequest;t.open("GET",this.url,!0),t.responseType="arraybuffer";var o=this;t.onload=function(){jWebAudio.context.decodeAudioData(t.response,function(t){return o.multishot?o.sound=new jWebAudio.WebAudioMultishotSound(t):o.sound=new jWebAudio.WebAudioSound(t,o.finish),o.sound.options=o.options,o.isLoaded=!0,e&&e(),!0},function(){return console.error("Cannot decode: "+o.url),!1})},t.onerror=function(){console.error("Load error")},t.send()}},jWebAudio.extend=function(e,t){var o=function(){};o.prototype=t.prototype,e.prototype=new o,e.prototype.constructor=e},jWebAudio.leftMerge=function(e,t){for(var o in t)e.hasOwnProperty(o)&&("object"==typeof e[o]?"object"==typeof t[o]&&leftMerge(e[o],t[o]):e[o]=t[o])},jWebAudio.Sound=function(){function e(){for(var e=0;e<s.length;++e)if(void 0!==s[e])return s[e];return null}function t(){for(var e=s.length-1;e>=0;--e)if(void 0!==s[e])return s[e];return null}this.STOPPED=0,this.PLAYING=1,this.PAUSED=2;var o=3,n=3,i=this,r={loop:!1,loopGap:0,muted:!1,volume:100,fadeIn:!1,fadeOut:!1,fadeInTime:o,fadeOutTime:n};this.getOptions=function(){return r},this.__defineGetter__("options",this.getOptions),this.setOptions=function(e){e&&("boolean"==typeof e.muted&&e.muted!==r.muted&&i.setMuted(e.muted),"number"==typeof e.volume&&e.volume!==r.volume&&i.setVolume(e.volume),"boolean"==typeof e.fadeIn&&(r.fadeIn=e.fadeIn,i.setFadeIn(r.fadeIn,e.fadeInTime)),"boolean"==typeof e.fadeOut&&(r.fadeOut=e.fadeOut,i.setFadeOut(r.fadeOut,e.fadeOutTime)),jWebAudio.leftMerge(r,e))},this.__defineSetter__("options",this.setOptions),this.setMuted=function(e){return"boolean"!=typeof e?void console.error("Error type of mute!"):(r.muted=e,void(e?a.gain.value=0:a.gain.value=r.volume/100))},this.getMuted=function(e){return i.options.muted},this.setVolume=function(e){return e=+e,isNaN(e)?void console.error("Error type of volume in setVolume"):(r.volume=e,void(a.gain.value=e/100))},this.getVolume=function(){return i.options.volume},this.getLoop=function(){return i.options.loop};var u=jWebAudio.context,a=u.createGain();this.__defineGetter__("gain",function(){return a});var s=[],d=[];this.addEffect=function(o){if("string"==typeof o&&(o=new jWebAudio.Effect(o)),!(o instanceof jWebAudio.Effect))return void console.error("Error in addEffect: effect is not instance of Effect");var n=e(),i=t();return null!==n?(i.outNode.disconnect(),i.outNode.connect(o.inNode)):(a.disconnect(),a.connect(o.inNode)),o.outNode.connect(u.destination),s.push(o),d.push(o.getName()),s.length-1},this.getEffectNames=function(){return d},this.getEffect=function(e){return s[e]},this.deleteEffect=function(e){if(void 0!==s[e]){for(var t=null,o=e-1;o>=0;--o)if(void 0!==s[o]){t=s[o].outNode;break}for(var n=u.destination,o=e+1;o<s.length;++o)if(void 0!==s[o]){n=s[o].inNode;break}null===t?(a.disconnect(),a.connect(n)):(t.disconnect(),t.connect(n)),delete s[e],delete d[e]}},this.clearAllEffects=function(){for(var e=s.length-1;e>=0;--e)if(void 0!==s[e])return a.disconnect(),s[e].outNode.disconnect(),a.connect(u.destination),s=[],void(d=[])},this.analysize=function(e,t){e&&(this._analyser.fftSize=2*e,this.fftData=new Uint8Array(this._analyser.frequencyBinCount)),this._fftCallback=t},this._analyser=null,this._analysize=function(){var e=u.createScriptProcessor(1024);this._analyser=u.createAnalyser(),e.connect(a),a.connect(this._analyser),this._analyser.connect(u.destination),this.fftData=new Uint8Array(this._analyser.frequencyBinCount);var t=this;e.onaudioprocess=function(e){t._analyser.getByteTimeDomainData(t.fftData),t._fftCallback&&t._fftCallback(t.fftData)}},this._analysize()},jWebAudio.WebAudioSound=function(e,t){function o(){var e=s.duration-d;a=r.createBufferSource(),a.buffer=s,a.loop=i.options.loop,a.connect(u),i.options.fadeIn&&(u.gain.setValueAtTime(u.gain.minValue,r.currentTime),u.gain.linearRampToValueAtTime(u.gain.maxValue,r.currentTime+i.options.fadeInTime)),a.start(0,d,e),f=r.currentTime,c=i.PLAYING;var n=function(){return setTimeout(function(){i.options.loop===!0?(i.seek(0),i.options.loopGap&&i.options.loopGap>0&&(i.stop(),loopGapEvent=setTimeout(function(){o()},1e3*i.options.loopGap))):(d=0,c=i.STOPPED),t&&t()},1e3*e)};if(l=n(),i.options.fadeOut===!0){var h=function(){return setTimeout(function(){u.gain.setValueAtTime(u.gain.maxValue,r.currentTime),u.gain.linearRampToValueAtTime(u.gain.minValue,r.currentTime+i.options.fadeOutTime)},1e3*(e-i.options.fadeOutTime))};p=h()}}function n(){c===i.PLAYING&&(a.stop(),a=null,d+=r.currentTime-f,clearTimeout(l),clearTimeout(p))}jWebAudio.Sound.call(this);var i=this,r=jWebAudio.context,u=r.createGain();u.connect(i.gain);var a=null,s=e;this.__defineGetter__("duration",function(){return s.duration});var d=0;this.__defineGetter__("offset",function(){return c===i.PLAYING?r.currentTime-f+d:d}),this.seek=function(e){if("number"!=typeof e||0>e||e>s.duration)return void console.error("Error arg in WebAudioSound.");var t=c;n(),d=e,t===this.PLAYING&&o()};var f=0,c=this.STOPPED;this.__defineGetter__("state",function(){return c});var l=null,p=null;this.play=function(){c!==i.PLAYING&&o()},this.pause=function(){c===i.PLAYING&&(n(),c=i.PAUSED)},this.stop=function(){function e(){n(),d=0,c=i.STOPPED}if(c!==i.STOPPED)if(i.options.fadeOut){var t=i.options.fadeOutTime;u.gain.linearRampToValueAtTime(u.gain.minValue,r.currentTime+t),setTimeout(function(){e()},1e3*t)}else e()},this.setFadeIn=function(e,t){"boolean"==typeof e?(i.options.fadeIn=e,"number"==typeof t&&(i.options.fadeInTime=t)):(i.options.fadeOut=ifFadeOut,console.error("Error type in setFadeIn."))},this.setFadeOut=function(e,t){"boolean"==typeof e&&"number"==typeof t&&(i.options.fadeOutTime=t)}},jWebAudio.extend(jWebAudio.WebAudioSound,jWebAudio.Sound),jWebAudio.WebAudioMultishotSound=function(e){jWebAudio.Sound.call(this);var t=jWebAudio.context,o=e,n=[],i=this;this.play=function(){var e=t.createBufferSource();e.buffer=o,e.loop=this.loop,e.connect(i.gain),e.start(),n.push(e)},this.stop=function(){n.forEach(function(e){e.stop(),e.disconnect()}),n=[]}},jWebAudio.extend(jWebAudio.WebAudioMultishotSound,jWebAudio.Sound),jWebAudio.Effect=function(e){return"telephonize"===e?new jWebAudio.Filter(e,[{type:jWebAudio.Filter.prototype.LOWPASS,frequency:2e3},{type:jWebAudio.Filter.prototype.HIGHPASS,frequency:500}]):"cathedral"===e?new jWebAudio.Filter(e,[{type:jWebAudio.Filter.prototype.BANDPASS,frequency:3e3},{type:jWebAudio.Filter.prototype.ALLPASS,frequency:1e3}]):"3d"===e?new jWebAudio.Spatiality:void console.error('Effect name: "'+e+'" not found')},jWebAudio.Filter=function(e,t){var o=e;this.getName=function(){return o};var n,i,r,u,a=[],s=[];if(t instanceof Array)a=t;else{if(!(t instanceof Object))return;a.push(t)}var d=jWebAudio.context;for(n=0;n<a.length;++n)r=a[n],r.type>=0&&r.type<=7&&(u=d.createBiquadFilter(),u.type=r.type,u.frequency.value=r.frequency,u.Q.value=r.Q,u.gain.value=r.gain,s.push(u));for(n=0;n<s.length-1;++n)i=n+1,s[n].connect(s[i]);this.__defineGetter__("inNode",function(){return s[0]}),this.__defineGetter__("outNode",function(){return s[s.length-1]})},jWebAudio.extend(jWebAudio.Filter,jWebAudio.Effect),jWebAudio.Filter.prototype.LOWPASS=0,jWebAudio.Filter.prototype.HIGHPASS=1,jWebAudio.Filter.prototype.BANDPASS=2,jWebAudio.Filter.prototype.LOWSHELF=3,jWebAudio.Filter.prototype.HIGHSHELF=4,jWebAudio.Filter.prototype.PEAKING=5,jWebAudio.Filter.prototype.NOTCH=6,jWebAudio.Filter.prototype.ALLPASS=7,jWebAudio.Spatiality=function(){var e=jWebAudio.context;this.soundObject=e.createPanner();var t=this;this.__defineGetter__("inNode",function(){return t.soundObject}),this.__defineGetter__("outNode",function(){return t.soundObject})},jWebAudio.extend(jWebAudio.Spatiality,jWebAudio.Effect),jWebAudio.Spatiality.prototype.getName=function(){return"3d"};
